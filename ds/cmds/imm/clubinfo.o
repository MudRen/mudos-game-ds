#include <mudlib.h>
#include <ansi.h>
string which_club;

int sort_member(object ob1, object ob2)
{
	int lv1,lv2;
	lv1=CLUB_D->check_member(which_club,getuid(ob1));
	lv2=CLUB_D->check_member(which_club,getuid(ob2));
	if(lv1 == lv2) return (int)ob1->query("level") - (int)ob2->query("level");
	else return (lv1 - lv2);
}
string show_level(object user)
{
 int level,rank;
 mapping info;
 string str;

 switch(which_club)
 {
 	case "dragon":

		 if(wizardp(user)) return "【榮譽會員】狂龍幫特級顧問  ";
		 level=user->query("level");
		 if(level>100) 	str = "【????????】";
		 else if(level<11)	str = "【第 "+chinese_number(level)+" 級】";
		 else if(level<21) 	str = "【第"+chinese_number(level)+"級】";
		 else if(level%10==0)   str = "【第"+chinese_number(level)+"級】";
		 else str = "【"+chinese_number(level)+"級】";
		 info=CLUB_D->query_member_info(which_club,getuid(user));
		 rank=info["level"];
		 switch(rank)
		 {
		 	case 6: str+="狂龍幫龍頭老大  "; break;
		 	case 5: str+="狂龍幫副幫主    "; break;
		 	case 4: str+="狂龍幫長老      "; break;
		 	case 3: str+="狂龍幫超級護法  "; break;
		 	case 2: str+=info["info1"]+"分堂主    "; break;
		 	default: 
		 		if(info["info1"]!="無")
		 		{
		 			str+=info["info1"]+"堂員      "; break;
		 		} else str+="狂龍幫一般幫眾  ";
		 }
	 	break;
	case "moon":
		 if(wizardp(user)) return "【榮譽會員】月族特級顧問    ";
		 level=user->query("level");
		 if(level>100) 	str = "【????????】";
		 else if(level<11)	str = "【第 "+chinese_number(level)+" 級】";
		 else if(level<21) 	str = "【第"+chinese_number(level)+"級】";
		 else if(level%10==0)   str = "【第"+chinese_number(level)+"級】";
		 else str = "【"+chinese_number(level)+"級】";
		 info=CLUB_D->query_member_info(which_club,getuid(user));
		 rank=info["level"];
		 switch(rank)
		 {
		 	case 5: str+="月之一族大族長  "; break;
		 	case 4: str+="月之一族副族長  "; break;
		 	case 3: str+="月之一族長老    "; break;
		  	case 2: str+=info["info1"]+"旗主      "; break;
		 	default: 
		 		if(info["info1"]!="無")
		 		{
		 			str+="月族"+info["info1"]+"成員  "; break;
		 		} else str+="月之一族族人    ";
		 }
		 break;
	default:
	 	 if(wizardp(user)) return "【榮譽會員】巫師級特級顧問  ";
		 level=user->query("level");
		 if(level>100) 	str = "【????????】";
		 else if(level<11)	str = "【第 "+chinese_number(level)+" 級】";
		 else if(level<21) 	str = "【第"+chinese_number(level)+"級】";
		 else if(level%10==0)   str = "【第"+chinese_number(level)+"級】";
		 else str = "【"+chinese_number(level)+"級】";
		 info=CLUB_D->query_member_info(which_club,getuid(user));
		 rank=info["level"];
		 switch(rank)
		 {
		 	case 9: str+="幫會等級九      "; break;
		 	case 8: str+="幫會等級八      "; break;
		 	case 7: str+="幫會等級七      "; break;
		 	case 6: str+="幫會等級六      "; break;
			case 5: str+="幫會等級五      "; break;
		 	case 4: str+="幫會等級四      "; break;
		 	case 3: str+="幫會等級三      "; break;
		 	case 2: str+="幫會等級二      "; break;
		 	case 1: str+="幫會等級一      "; break;
		 	default: 
				str+="其他幫會等級    ";
	 	}
	 	break;
 }
 return str;
}

int main(object me,string arg)
{
	object *users;
	string str;
	int i,ppl_cnt,idle;
	which_club="dragon";
	users = CLUB_D->find_online_members(which_club);
	str = "◎ 狂龍: \n";
	str += "─────────────────────────────────────\n";

	users = sort_array(users, "sort_member", this_object());

	ppl_cnt = 0;
	i = sizeof(users);
	while( i-- )
	{
			// Skip those users in login limbo.
			if(!me->visible(users[i])) continue;
			str = sprintf("%s%12s%-16s %s(%s)",
				str,
				show_level(users[i]),
				RANK_D->query_level(users[i]),
				users[i]->name(1),
				users[i]->query("id"),
			);
			if(users[i]->query_temp("killer")) str+=HIR" [殺人犯]"NOR;
			idle=query_idle(users[i]);
			if(users[i]->query_temp("invis")) str+=HIB"(隱形)"NOR;
			if(users[i]->query_temp("netdead")) str+=HIG"<斷線中>"NOR;
			if(idle>60) str +=sprintf(HIY" (發呆%d分鐘)"NOR,idle/60);
			str +=sprintf("\n"NOR);
			ppl_cnt++;
	}
	str += "─────────────────────────────────────\n";
	str = sprintf("%s目前共有 %d 位成員在線上.\n", str, ppl_cnt);

	str +="\n\n";

	ppl_cnt = 0;
	which_club="moon";
	users = CLUB_D->find_online_members(which_club);
	str += "◎ 月族: \n";
	str += "─────────────────────────────────────\n";

	users = sort_array(users, "sort_member", this_object());

	ppl_cnt = 0;
	i = sizeof(users);
	while( i-- )
	{
			// Skip those users in login limbo.
			if(!me->visible(users[i])) continue;
			str = sprintf("%s%12s%-16s %s(%s)",
				str,
				show_level(users[i]),
				RANK_D->query_level(users[i]),
				users[i]->name(1),
				users[i]->query("id"),
			);
			if(users[i]->query_temp("killer")) str+=HIR" [殺人犯]"NOR;
			idle=query_idle(users[i]);
			if(users[i]->query_temp("invis")) str+=HIB"(隱形)"NOR;
			if(users[i]->query_temp("netdead")) str+=HIG"<斷線中>"NOR;
			if(idle>60) str +=sprintf(HIY" (發呆%d分鐘)"NOR,idle/60);
			str +=sprintf("\n"NOR);
			ppl_cnt++;
	}
	str += "─────────────────────────────────────\n";
	str = sprintf("%s目前共有 %d 位成員在線上.\n", str, ppl_cnt);

	str +="\n\n";

	ppl_cnt = 0;
	which_club="sky";
	users = CLUB_D->find_online_members(which_club);
	str += "◎ 天地會: \n";
	str += "─────────────────────────────────────\n";

	users = sort_array(users, "sort_member", this_object());

	ppl_cnt = 0;
	i = sizeof(users);
	while( i-- )
	{
			// Skip those users in login limbo.
			if(!me->visible(users[i])) continue;
			str = sprintf("%s%12s%-16s %s(%s)",
				str,
				show_level(users[i]),
				RANK_D->query_level(users[i]),
				users[i]->name(1),
				users[i]->query("id"),
			);
			if(users[i]->query_temp("killer")) str+=HIR" [殺人犯]"NOR;
			idle=query_idle(users[i]);
			if(users[i]->query_temp("invis")) str+=HIB"(隱形)"NOR;
			if(users[i]->query_temp("netdead")) str+=HIG"<斷線中>"NOR;
			if(idle>60) str +=sprintf(HIY" (發呆%d分鐘)"NOR,idle/60);
			str +=sprintf("\n"NOR);
			ppl_cnt++;
	}
	str += "─────────────────────────────────────\n";
	str = sprintf("%s目前共有 %d 位成員在線上.\n", str, ppl_cnt);
		
	this_player()->start_more(str);
	return 1;
}
